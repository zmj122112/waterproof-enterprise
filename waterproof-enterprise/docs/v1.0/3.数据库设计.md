# 防水工程企业信息化平台 - 数据库设计

## 一、数据库概述

### 1.1 设计原则
- **数据完整性**：确保数据的准确性和一致性
- **数据安全性**：保护敏感数据，防止未授权访问
- **性能优化**：优化查询性能，提高系统响应速度
- **可扩展性**：支持数据量增长和业务扩展
- **标准化设计**：遵循数据库设计规范，减少数据冗余

### 1.2 数据库选型
- **主数据库**：MySQL 8.0
  - 支持事务处理
  - 成熟稳定，社区活跃
  - 良好的性能和可扩展性
- **缓存**：Redis 7.0
  - 用于缓存热点数据，提高系统性能
  - 支持数据持久化

### 1.3 数据库架构
- **生产环境**：主从架构
  - 主库负责读写操作
  - 从库负责读操作，提高系统并发能力
  - 数据自动同步，确保数据一致性

## 二、数据模型设计

### 2.1 核心业务域

根据业务需求，将数据库分为6大业务域：
1. **客户与渠道域**
2. **工单/项目域**
3. **人员与班组域**
4. **物料与设备域**
5. **财务与结算域**
6. **质保域**
7. **系统管理域**

### 2.2 实体关系图（ERD）

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│  customer  │─────│  workorder │─────│  project   │
└────────────┘     └────────────┘     └────────────┘
       │                  │                  │
       │                  │                  │
       │                  │                  ▼
       │                  │          ┌────────────┐
       │                  │          │  contract  │
       │                  │          └────────────┘
       │                  │
       │                  │
       │                  ▼
       │          ┌────────────┐
       │          │   quote    │
       │          └────────────┘
       │
       ▼
┌────────────┐     ┌────────────┐
│    lead    │     │  employee  │
└────────────┘     └────────────┘
                         │
                         │
                         ▼
                   ┌────────────┐
                   │team_employee│
                   └────────────┘

┌────────────┐     ┌────────────┐     ┌────────────┐
│  material  │─────│material_inventory│─────│ warehouse  │
└────────────┘     └────────────┘     └────────────┘
       │
       │
       ▼
┌────────────┐
│workorder_material│
└────────────┘

┌────────────┐     ┌────────────┐
│payment_receipt│─────│ cost_record │
└────────────┘     └────────────┘

┌────────────┐     ┌────────────┐
│  warranty  │─────│warranty_repair│
└────────────┘     └────────────┘

┌────────────┐     ┌────────────┐     ┌────────────┐
│  sys_user  │─────│  sys_role  │─────│  sys_menu  │
└────────────┘     └────────────┘     └────────────┘
```

## 三、核心表结构设计

### 3.1 客户与渠道域

#### 3.1.1 客户表（customer）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 客户ID |
| customer_type | ENUM('B', 'C') | NOT NULL | 客户类型：B-企业客户，C-个人客户 |
| customer_name | VARCHAR(255) | NOT NULL, UNIQUE | 客户名称 |
| contact_name | VARCHAR(100) | NULL | 联系人姓名 |
| contact_phone | VARCHAR(20) | NULL | 联系人电话 |
| contact_email | VARCHAR(100) | NULL | 联系人邮箱 |
| address | VARCHAR(500) | NULL | 地址 |
| customer_level | ENUM('VIP', 'NORMAL', 'NEW') | DEFAULT 'NEW' | 客户等级 |
| status | ENUM('ACTIVE', 'INACTIVE') | DEFAULT 'ACTIVE' | 状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.1.2 线索表（lead）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 线索ID |
| source | VARCHAR(100) | NOT NULL | 线索来源 |
| customer_name | VARCHAR(255) | NOT NULL | 客户名称 |
| contact_phone | VARCHAR(20) | NULL | 联系电话 |
| contact_email | VARCHAR(100) | NULL | 联系邮箱 |
| description | TEXT | NULL | 线索描述 |
| status | ENUM('NEW', 'QUALIFIED', 'CONVERTED', 'DISQUALIFIED') | DEFAULT 'NEW' | 线索状态 |
| assigned_to | BIGINT | NULL | 分配给 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.2 工单/项目域

#### 3.2.1 工单表（workorder）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 工单ID |
| workorder_no | VARCHAR(50) | NOT NULL, UNIQUE | 工单号 |
| customer_id | BIGINT | NOT NULL, FOREIGN KEY | 客户ID |
| project_id | BIGINT | NULL, FOREIGN KEY | 关联项目ID（B端项目） |
| workorder_type | VARCHAR(100) | NOT NULL | 工单类型：卫生间漏水、屋顶补漏等 |
| leak_type | VARCHAR(100) | NULL | 漏水类型 |
| leak_area | DECIMAL(10, 2) | NULL | 漏水面积 |
| description | TEXT | NULL | 问题描述 |
| address | VARCHAR(500) | NOT NULL | 服务地址 |
| status | ENUM('CREATED', 'ASSIGNED', 'SURVEYING', 'QUOTING', 'APPROVED', 'CONSTRUCTING', 'INSPECTING', 'COMPLETED', 'CANCELLED') | DEFAULT 'CREATED' | 工单状态 |
| created_by | BIGINT | NOT NULL | 创建人 |
| assigned_to | BIGINT | NULL | 分配给（师傅/班组） |
| estimate_price | DECIMAL(10, 2) | NULL | 预估价格 |
| actual_price | DECIMAL(10, 2) | NULL | 实际价格 |
| start_time | DATETIME | NULL | 开工时间 |
| end_time | DATETIME | NULL | 完工时间 |
| warranty_start | DATETIME | NULL | 质保开始时间 |
| warranty_end | DATETIME | NULL | 质保结束时间 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.2 项目表（project）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 项目ID |
| project_no | VARCHAR(50) | NOT NULL, UNIQUE | 项目编号 |
| customer_id | BIGINT | NOT NULL, FOREIGN KEY | 客户ID |
| project_name | VARCHAR(255) | NOT NULL | 项目名称 |
| project_type | VARCHAR(100) | NOT NULL | 项目类型 |
| contract_id | BIGINT | NULL, FOREIGN KEY | 关联合同ID |
| status | ENUM('PLANNING', 'EXECUTING', 'COMPLETED', 'CANCELLED') | DEFAULT 'PLANNING' | 项目状态 |
| estimated_cost | DECIMAL(10, 2) | NULL | 预估成本 |
| actual_cost | DECIMAL(10, 2) | NULL | 实际成本 |
| estimated_revenue | DECIMAL(10, 2) | NULL | 预估收入 |
| actual_revenue | DECIMAL(10, 2) | NULL | 实际收入 |
| start_date | DATE | NULL | 开始日期 |
| end_date | DATE | NULL | 结束日期 |
| created_by | BIGINT | NOT NULL | 创建人 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.3 工单勘察记录表（workorder_survey）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 勘察记录ID |
| workorder_id | BIGINT | NOT NULL, UNIQUE, FOREIGN KEY | 工单ID |
| surveyor_id | BIGINT | NOT NULL | 勘察人ID |
| survey_time | DATETIME | NOT NULL | 勘察时间 |
| leak_point | VARCHAR(255) | NULL | 漏水点 |
| leak_cause | TEXT | NULL | 漏水原因 |
| solution | TEXT | NULL | 解决方案 |
| photos | JSON | NULL | 勘察照片（JSON数组） |
| videos | JSON | NULL | 勘察视频（JSON数组） |
| notes | TEXT | NULL | 备注 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.4 工单施工记录表（workorder_construction）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 施工记录ID |
| workorder_id | BIGINT | NOT NULL, FOREIGN KEY | 工单ID |
| constructor_id | BIGINT | NOT NULL | 施工人ID |
| construction_date | DATE | NOT NULL | 施工日期 |
| start_time | TIME | NOT NULL | 开工时间 |
| end_time | TIME | NOT NULL | 完工时间 |
| process | TEXT | NOT NULL | 施工过程 |
| materials_used | JSON | NULL | 使用材料（JSON数组） |
| photos | JSON | NULL | 施工照片（JSON数组） |
| videos | JSON | NULL | 施工视频（JSON数组） |
| weather | VARCHAR(50) | NULL | 天气情况 |
| notes | TEXT | NULL | 备注 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.5 工单验收记录表（workorder_inspection）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 验收记录ID |
| workorder_id | BIGINT | NOT NULL, UNIQUE, FOREIGN KEY | 工单ID |
| inspector_id | BIGINT | NOT NULL | 验收人ID |
| inspection_time | DATETIME | NOT NULL | 验收时间 |
| result | ENUM('PASS', 'FAIL') | NOT NULL | 验收结果 |
| comments | TEXT | NULL | 验收意见 |
| photos | JSON | NULL | 验收照片（JSON数组） |
| customer_signature | VARCHAR(255) | NULL | 客户签字（图片路径） |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.3 人员与班组域

#### 3.3.1 人员表（employee）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 人员ID |
| employee_type | ENUM('STAFF', 'MASTER', 'TEAM') | NOT NULL | 人员类型：STAFF-自有员工，MASTER-外包师傅，TEAM-施工班组 |
| name | VARCHAR(100) | NOT NULL | 姓名/班组名称 |
| phone | VARCHAR(20) | NOT NULL, UNIQUE | 电话 |
| id_card | VARCHAR(18) | NULL | 身份证号 |
| skills | JSON | NULL | 技能标签（JSON数组） |
| qualifications | JSON | NULL | 资质证照（JSON数组） |
| status | ENUM('ACTIVE', 'INACTIVE') | DEFAULT 'ACTIVE' | 状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.3.2 班组人员关联表（team_employee）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| team_id | BIGINT | NOT NULL, PRIMARY KEY, FOREIGN KEY | 班组ID |
| employee_id | BIGINT | NOT NULL, PRIMARY KEY, FOREIGN KEY | 人员ID |
| role | VARCHAR(50) | NOT NULL | 在班组中的角色 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 3.4 物料与设备域

#### 3.4.1 物料表（material）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 物料ID |
| material_code | VARCHAR(50) | NOT NULL, UNIQUE | 物料编码 |
| material_name | VARCHAR(255) | NOT NULL | 物料名称 |
| specification | VARCHAR(255) | NULL | 规格型号 |
| unit | VARCHAR(20) | NOT NULL | 计量单位 |
| material_type | VARCHAR(100) | NOT NULL | 物料类型 |
| brand | VARCHAR(100) | NULL | 品牌 |
| status | ENUM('ACTIVE', 'INACTIVE') | DEFAULT 'ACTIVE' | 状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.4.2 物料库存表（material_inventory）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 库存ID |
| material_id | BIGINT | NOT NULL | 物料ID |
| warehouse_id | BIGINT | NOT NULL | 仓库ID |
| quantity | DECIMAL(10, 2) | NOT NULL DEFAULT 0 | 库存数量 |
| unit_price | DECIMAL(10, 2) | NULL | 单位成本 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| UNIQUE KEY | (material_id, warehouse_id) | | 物料与仓库组合唯一 |

#### 3.4.3 工单物料使用表（workorder_material）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | ID |
| workorder_id | BIGINT | NOT NULL, FOREIGN KEY | 工单ID |
| material_id | BIGINT | NOT NULL, FOREIGN KEY | 物料ID |
| quantity | DECIMAL(10, 2) | NOT NULL | 使用数量 |
| unit_price | DECIMAL(10, 2) | NOT NULL | 单价 |
| total_amount | DECIMAL(10, 2) | NOT NULL | 总金额 |
| used_at | DATETIME | NOT NULL | 使用时间 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

### 3.5 财务与结算域

#### 3.5.1 合同表（contract）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 合同ID |
| contract_no | VARCHAR(50) | NOT NULL, UNIQUE | 合同编号 |
| project_id | BIGINT | NOT NULL, FOREIGN KEY | 项目ID |
| contract_name | VARCHAR(255) | NOT NULL | 合同名称 |
| contract_amount | DECIMAL(10, 2) | NOT NULL | 合同金额 |
| sign_date | DATE | NOT NULL | 签订日期 |
| start_date | DATE | NOT NULL | 合同开始日期 |
| end_date | DATE | NOT NULL | 合同结束日期 |
| status | ENUM('DRAFT', 'SIGNED', 'EXECUTING', 'COMPLETED', 'TERMINATED') | DEFAULT 'DRAFT' | 合同状态 |
| created_by | BIGINT | NOT NULL | 创建人 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.5.2 报价表（quote）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 报价ID |
| quote_no | VARCHAR(50) | NOT NULL, UNIQUE | 报价编号 |
| workorder_id | BIGINT | NOT NULL, UNIQUE, FOREIGN KEY | 工单ID |
| quote_type | ENUM('RANGE', 'EXACT') | NOT NULL | 报价类型：RANGE-区间价，EXACT-精确价 |
| min_price | DECIMAL(10, 2) | NULL | 最低价格（区间价） |
| max_price | DECIMAL(10, 2) | NULL | 最高价格（区间价） |
| exact_price | DECIMAL(10, 2) | NULL | 精确价格 |
| description | TEXT | NULL | 报价说明 |
| status | ENUM('DRAFT', 'SUBMITTED', 'APPROVED', 'REJECTED') | DEFAULT 'DRAFT' | 报价状态 |
| created_by | BIGINT | NOT NULL | 创建人 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.5.3 收款记录表（payment_receipt）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 收款记录ID |
| receipt_no | VARCHAR(50) | NOT NULL, UNIQUE | 收款单号 |
| workorder_id | BIGINT | NULL, FOREIGN KEY | 工单ID |
| project_id | BIGINT | NULL, FOREIGN KEY | 项目ID |
| customer_id | BIGINT | NOT NULL, FOREIGN KEY | 客户ID |
| amount | DECIMAL(10, 2) | NOT NULL | 收款金额 |
| payment_method | ENUM('CASH', 'TRANSFER', 'WECHAT', 'ALIPAY') | NOT NULL | 支付方式 |
| payment_date | DATETIME | NOT NULL | 收款日期 |
| status | ENUM('SUCCESS', 'FAILED', 'REFUNDED') | DEFAULT 'SUCCESS' | 收款状态 |
| notes | TEXT | NULL | 备注 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.5.4 成本记录表（cost_record）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 成本记录ID |
| cost_no | VARCHAR(50) | NOT NULL, UNIQUE | 成本单号 |
| workorder_id | BIGINT | NULL, FOREIGN KEY | 工单ID |
| project_id | BIGINT | NULL, FOREIGN KEY | 项目ID |
| cost_type | VARCHAR(100) | NOT NULL | 成本类型：材料成本、人工成本、设备成本等 |
| amount | DECIMAL(10, 2) | NOT NULL | 成本金额 |
| description | TEXT | NULL | 成本描述 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.6 质保域

#### 3.6.1 质保信息表（warranty）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 质保ID |
| workorder_id | BIGINT | NOT NULL, UNIQUE, FOREIGN KEY | 工单ID |
| customer_id | BIGINT | NOT NULL, FOREIGN KEY | 客户ID |
| warranty_type | VARCHAR(100) | NOT NULL | 质保类型 |
| warranty_period | INT | NOT NULL | 质保期限（月） |
| start_date | DATETIME | NOT NULL | 质保开始时间 |
| end_date | DATETIME | NOT NULL | 质保结束时间 |
| status | ENUM('ACTIVE', 'EXPIRED', 'TERMINATED') | DEFAULT 'ACTIVE' | 质保状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.6.2 质保维修记录表（warranty_repair）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 质保维修ID |
| warranty_id | BIGINT | NOT NULL, FOREIGN KEY | 质保ID |
| workorder_id | BIGINT | NOT NULL, FOREIGN KEY | 原工单ID |
| repair_workorder_id | BIGINT | NULL, FOREIGN KEY | 维修工单ID |
| problem_description | TEXT | NOT NULL | 问题描述 |
| repair_result | TEXT | NULL | 维修结果 |
| status | ENUM('CREATED', 'PROCESSING', 'COMPLETED', 'REJECTED') | DEFAULT 'CREATED' | 维修状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.7 系统管理域

#### 3.7.1 系统用户表（sys_user）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码 |
| real_name | VARCHAR(100) | NOT NULL | 真实姓名 |
| phone | VARCHAR(20) | NOT NULL | 电话 |
| email | VARCHAR(100) | NULL | 邮箱 |
| status | ENUM('ACTIVE', 'INACTIVE') | DEFAULT 'ACTIVE' | 状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.7.2 系统角色表（sys_role）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 角色ID |
| role_name | VARCHAR(100) | NOT NULL | 角色名称 |
| role_code | VARCHAR(50) | NOT NULL, UNIQUE | 角色编码 |
| description | VARCHAR(255) | NULL | 角色描述 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.7.3 用户角色关联表（sys_user_role）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| user_id | BIGINT | NOT NULL, PRIMARY KEY, FOREIGN KEY | 用户ID |
| role_id | BIGINT | NOT NULL, PRIMARY KEY, FOREIGN KEY | 角色ID |

#### 3.7.4 系统菜单表（sys_menu）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 菜单ID |
| parent_id | BIGINT | NULL, FOREIGN KEY | 父菜单ID |
| menu_name | VARCHAR(100) | NOT NULL | 菜单名称 |
| menu_type | ENUM('MENU', 'BUTTON', 'API') | NOT NULL | 菜单类型 |
| path | VARCHAR(255) | NULL | 路径 |
| component | VARCHAR(255) | NULL | 组件 |
| permission | VARCHAR(100) | NULL | 权限标识 |
| icon | VARCHAR(50) | NULL | 图标 |
| order_num | INT | DEFAULT 0 | 排序 |
| status | ENUM('ACTIVE', 'INACTIVE') | DEFAULT 'ACTIVE' | 状态 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 3.7.5 角色菜单关联表（sys_role_menu）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| role_id | BIGINT | NOT NULL, PRIMARY KEY, FOREIGN KEY | 角色ID |
| menu_id | BIGINT | NOT NULL, PRIMARY KEY, FOREIGN KEY | 菜单ID |

## 四、索引设计

### 4.1 主键索引
- 每个表的主键都自动创建主键索引

### 4.2 唯一索引
- 确保数据唯一性，如工单号、合同编号等
- 示例：`workorder.workorder_no`、`contract.contract_no`

### 4.3 普通索引
- 用于频繁查询的字段，提高查询性能
- 示例：
  - `workorder.status` - 按状态查询工单
  - `workorder.customer_id` - 按客户查询工单
  - `project.project_status` - 按状态查询项目
  - `employee.phone` - 按电话查询人员

### 4.4 复合索引
- 用于多个字段组合查询的场景
- 示例：
  - `workorder_survey.workorder_id, survey_time` - 按工单和时间查询勘察记录
  - `payment_receipt.customer_id, payment_date` - 按客户和日期查询收款记录

## 五、视图和存储过程

### 5.1 视图
- 用于简化复杂查询，提高查询效率
- 示例：
  - `v_workorder_detail` - 工单详情视图，包含客户信息、勘察信息等
  - `v_project_finance` - 项目财务视图，包含收入、成本、利润等

### 5.2 存储过程
- 用于处理复杂业务逻辑，提高性能
- 示例：
  - `sp_generate_workorder_no` - 生成工单号
  - `sp_calculate_project_profit` - 计算项目利润
  - `sp_update_warranty_status` - 更新质保状态

## 六、数据迁移和初始化

### 6.1 数据迁移策略
- 使用Sequelize的迁移功能，管理数据库 schema 变更
- 每次变更都生成迁移文件，便于版本控制和回滚

### 6.2 初始数据
- 系统管理员账号
- 基础字典数据
- 初始角色和权限
- 基础物料数据

## 七、数据库维护

### 7.1 备份策略
- **全量备份**：每天凌晨执行一次全量备份
- **增量备份**：每小时执行一次增量备份
- **日志备份**：实时备份binlog日志
- **异地备份**：备份数据同步到异地存储

### 7.2 优化策略
- 定期分析慢查询日志，优化查询语句
- 定期优化表结构，重建索引
- 监控数据库性能，及时调整配置

### 7.3 安全策略
- 定期更新数据库密码
- 限制数据库访问IP
- 启用数据库审计日志
- 定期进行安全扫描

## 八、性能优化

### 8.1 查询优化
- 避免全表扫描，使用索引
- 优化JOIN查询，减少关联表数量
- 合理使用分页查询
- 避免在WHERE子句中使用函数

### 8.2 写入优化
- 批量插入数据
- 合理使用事务
- 避免频繁更新大表

### 8.3 缓存策略
- 使用Redis缓存热点数据
- 缓存查询结果
- 设置合理的缓存过期时间

## 九、扩展设计

### 9.1 分库分表策略
- **分库**：按业务域分库，如客户库、工单库、项目库等
- **分表**：按时间或业务ID分表，如按月份分表的工单表

### 9.2 读写分离
- 主库负责写操作，从库负责读操作
- 使用MySQL的主从复制功能
- 应用层实现读写分离

### 9.3 数据归档
- 定期归档历史数据
- 归档策略：按时间归档，如归档超过1年的数据
- 归档方式：将历史数据迁移到归档数据库
