# 防水工程企业信息化平台 - 技术架构设计

## 一、架构概述

### 1.1 设计原则
- **分层架构**：清晰的5层架构设计，各层职责明确，便于维护和扩展
- **微服务化**：业务模块独立部署，便于团队协作和独立扩展
- **前后端分离**：前端与后端通过API通信，便于多端开发和维护
- **高可用性**：采用冗余设计和负载均衡，确保系统稳定运行
- **安全性**：多层次安全防护，包括认证授权、数据加密、安全审计等
- **可扩展性**：模块化设计，便于新增功能和集成第三方系统

### 1.2 架构视图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              应用层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ C端小程序  │  │  B端门户   │  │  师傅端    │  │ 管理系统   │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          API网关层                                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ 路由转发   │  │ 负载均衡   │  │ 认证授权   │  │ 限流熔断   │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          业务应用层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ 工单管理   │  │ 项目管理   │  │ 合同管理   │  │ 报价管理   │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ 人员管理   │  │ 物料管理   │  │ 财务管理   │  │ 质保管理   │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          业务中台层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ 组织权限   │  │ 流程管理   │  │ 规则引擎   │  │ 字典管理   │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                        │
│  │ 价格模型   │  │ 质保规则   │  │ 结算规则   │                        │
│  └────────────┘  └────────────┘  └────────────┘                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据与集成层                                │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ 主数据管理 │  │ 数据仓库   │  │ BI分析     │  │ 用友NC接口  │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          基础设施层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ 服务器     │  │ 数据库     │  │ 缓存       │  │ 存储       │       │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                        │
│  │ 网络设备   │  │ 安全设备   │  │ 监控系统   │                        │
│  └────────────┘  └────────────┘  └────────────┘                        │
└─────────────────────────────────────────────────────────────────────────┘
```

## 二、各层详细设计

### 2.1 应用层

#### 2.1.1 C端小程序
- **技术栈**：微信小程序原生开发
- **核心功能**：
  - 报修/估价
  - 预约上门
  - 工单进度查询
  - 支付/评价
  - 质保查询
- **特点**：
  - 轻量级，无需下载
  - 微信生态，便于分享和推广
  - 支持多种支付方式

#### 2.1.2 B端门户
- **技术栈**：Vue.js + Element UI
- **核心功能**：
  - 批量报修
  - 合同项目管理
  - 台账与对账
  - SLA统计
- **特点**：
  - 响应式设计，支持多端访问
  - 企业微信集成，便于内部沟通
  - 数据可视化，便于决策分析

#### 2.1.3 师傅端
- **技术栈**：微信小程序原生开发
- **核心功能**：
  - 工单接收
  - 施工记录
  - 材料领用
  - 完工确认
- **特点**：
  - 实时消息推送
  - 定位功能，便于派工
  - 离线缓存，支持无网络环境

#### 2.1.4 管理系统
- **技术栈**：Vue.js + Element UI
- **核心功能**：
  - 工单/项目管理
  - 客户管理
  - 人员管理
  - 物料管理
  - 财务管理
  - 数据分析
- **特点**：
  - 模块化设计，便于扩展
  - 权限精细化管理
  - 工作流引擎，支持自定义审批流程

### 2.2 API网关层

#### 2.2.1 核心功能
- **路由转发**：根据请求路径将请求转发到对应的业务服务
- **负载均衡**：将请求分发到多个实例，提高系统可用性
- **认证授权**：基于JWT的身份验证和基于角色的权限控制
- **限流熔断**：防止系统过载，保护后端服务
- **日志审计**：记录所有请求日志，便于排查问题和安全审计

#### 2.2.2 技术选型
- **框架**：Express Gateway
- **认证**：JWT
- **限流**：Redis + Lua脚本
- **熔断**：Hystrix

### 2.3 业务应用层

#### 2.3.1 模块设计

| 模块名称 | 主要功能 | 技术栈 |
|---------|---------|-------|
| 工单管理 | 工单创建、分配、勘察、施工、验收 | Node.js + Express + Sequelize |
| 项目管理 | 项目立项、进度跟踪、资源调度 | Node.js + Express + Sequelize |
| 合同管理 | 合同起草、审批、执行、归档 | Node.js + Express + Sequelize |
| 报价管理 | 报价生成、审批、变更 | Node.js + Express + Sequelize |
| 人员管理 | 人员信息、班组管理、资质管理 | Node.js + Express + Sequelize |
| 物料管理 | 物料信息、库存管理、领用管理 | Node.js + Express + Sequelize |
| 财务管理 | 成本核算、应收应付、NC对接 | Node.js + Express + Sequelize |
| 质保管理 | 质保信息、维修记录、复漏分析 | Node.js + Express + Sequelize |

#### 2.3.2 服务间通信
- **同步通信**：RESTful API
- **异步通信**：RabbitMQ

### 2.4 业务中台层

#### 2.4.1 组织/权限管理
- **功能**：用户管理、角色管理、权限管理、组织架构管理
- **特点**：
  - 基于RBAC的权限模型
  - 支持多级组织架构
  - 细粒度的权限控制

#### 2.4.2 流程管理
- **功能**：流程定义、流程实例管理、任务分配、流程监控
- **特点**：
  - 可视化流程设计
  - 支持自定义流程
  - 流程版本管理

#### 2.4.3 规则管理
- **功能**：规则定义、规则引擎、规则执行
- **特点**：
  - 可视化规则配置
  - 支持动态规则更新
  - 规则引擎高效执行

#### 2.4.4 字典管理
- **功能**：字典定义、字典项管理、字典查询
- **特点**：
  - 集中管理系统字典
  - 支持多级字典
  - 字典变更日志

#### 2.4.5 价格模型
- **功能**：报价规则定义、价格计算、价格审批
- **特点**：
  - 基于规则的自动报价
  - 支持多种报价模板
  - 价格变更历史记录

#### 2.4.6 质保规则
- **功能**：质保期限定义、质保范围定义、质保维修规则
- **特点**：
  - 灵活的质保规则配置
  - 自动计算质保期限
  - 质保维修流程自动化

#### 2.4.7 结算规则
- **功能**：结算方式定义、结算周期定义、结算审批流程
- **特点**：
  - 支持多种结算方式
  - 自动生成结算单
  - 结算流程自动化

### 2.5 数据与集成层

#### 2.5.1 主数据管理
- **功能**：客户主数据、产品主数据、供应商主数据
- **特点**：
  - 统一的数据标准
  - 数据质量监控
  - 数据同步机制

#### 2.5.2 数据仓库
- **功能**：数据采集、数据清洗、数据存储、数据建模
- **特点**：
  - 基于维度模型设计
  - 支持增量数据同步
  - 数据分层管理

#### 2.5.3 BI分析
- **功能**：报表设计、数据分析、数据可视化、数据挖掘
- **特点**：
  - 可视化报表设计
  - 支持多种图表类型
  - 实时数据更新

#### 2.5.4 用友NC接口
- **功能**：财务数据同步、凭证生成、报表查询
- **特点**：
  - 双向数据同步
  - 事务一致性保证
  - 错误重试机制

### 2.6 基础设施层

#### 2.6.1 服务器
- **类型**：云服务器/物理服务器
- **配置**：
  - 应用服务器：8核16G
  - 数据库服务器：16核32G
  - 中间件服务器：8核16G

#### 2.6.2 数据库
- **关系型数据库**：MySQL 8.0
  - 主从架构，保证数据可用性
  - 定期备份，防止数据丢失
- **缓存**：Redis 7.0
  - 分布式缓存，提高系统性能
  - 支持数据持久化

#### 2.6.3 存储
- **对象存储**：阿里云OSS/腾讯云COS
  - 用于存储图片、视频等大文件
  - 支持CDN加速

#### 2.6.4 安全设备
- **防火墙**：防止恶意攻击
- **WAF**：Web应用防火墙，防止Web攻击
- **SSL证书**：数据加密传输

## 三、技术选型

### 3.1 后端技术
| 类别 | 技术 | 版本 | 用途 |
|-----|-----|-----|-----|
| 语言 | Node.js | 18.x | 后端开发语言 |
| 框架 | Express | 4.x | Web框架 |
| ORM | Sequelize | 6.x | 数据库操作 |
| 数据库 | MySQL | 8.0 | 关系型数据存储 |
| 缓存 | Redis | 7.0 | 缓存存储 |
| 消息队列 | RabbitMQ | 3.12 | 异步通信 |
| 认证 | JWT | - | 身份认证 |
| API网关 | Express Gateway | 1.25 | API管理 |

### 3.2 前端技术
| 类别 | 技术 | 版本 | 用途 |
|-----|-----|-----|-----|
| 框架 | Vue.js | 3.x | 前端框架 |
| UI组件库 | Element UI | 2.x | 管理系统UI |
| 小程序 | 微信小程序 | - | C端和师傅端 |
| 状态管理 | Pinia | 2.x | 前端状态管理 |
| 路由 | Vue Router | 4.x | 前端路由 |
| HTTP客户端 | Axios | 1.x | API调用 |

### 3.3 运维技术
| 类别 | 技术 | 版本 | 用途 |
|-----|-----|-----|-----|
| 容器化 | Docker | 24.x | 应用容器化 |
| 编排 | Kubernetes | 1.27 | 容器编排 |
| CI/CD | Jenkins | 2.414 | 持续集成/持续部署 |
| 监控 | Prometheus + Grafana | 2.45 + 10.2 | 系统监控 |
| 日志 | ELK Stack | 8.x | 日志管理 |

## 四、安全设计

### 4.1 认证与授权
- **认证方式**：
  - 用户名密码认证
  - 微信授权登录
  - JWT令牌认证
- **授权方式**：
  - 基于角色的访问控制（RBAC）
  - 细粒度的权限控制
  - 动态权限调整

### 4.2 数据安全
- **数据加密**：
  - 传输加密：HTTPS
  - 存储加密：数据库加密
  - 敏感数据加密：如密码、身份证号等
- **数据备份**：
  - 定期全量备份
  - 实时增量备份
  - 异地备份

### 4.3 应用安全
- **输入验证**：防止SQL注入、XSS攻击
- **输出编码**：防止XSS攻击
- **CSRF防护**：防止跨站请求伪造
- **接口限流**：防止DDoS攻击

### 4.4 安全审计
- **日志记录**：所有重要操作都记录日志
- **审计分析**：定期分析日志，发现异常行为
- **安全扫描**：定期进行漏洞扫描和安全评估

## 五、部署架构

### 5.1 部署模式
- **开发环境**：单机部署，便于开发和测试
- **测试环境**：模拟生产环境，用于功能测试和性能测试
- **生产环境**：
  - 分布式部署，提高系统可用性
  - 负载均衡，提高系统性能
  - 容器化部署，便于管理和扩展

### 5.2 网络架构
- **DMZ区**：部署API网关、Web服务器等对外服务
- **业务区**：部署业务应用服务
- **数据区**：部署数据库、缓存等数据服务
- **管理区**：部署监控、日志等管理服务

## 六、扩展性设计

### 6.1 横向扩展
- **业务模块**：支持独立部署，可根据需求扩展实例数量
- **数据库**：支持分库分表，处理大量数据
- **缓存**：支持集群部署，提高缓存容量和性能

### 6.2 纵向扩展
- **功能扩展**：模块化设计，便于新增功能模块
- **集成扩展**：提供标准API，便于集成第三方系统
- **平台扩展**：支持多租户设计，便于未来业务扩展

## 七、监控与运维

### 7.1 监控指标
- **系统指标**：CPU、内存、磁盘、网络等
- **应用指标**：响应时间、请求数、错误率等
- **业务指标**：工单数量、项目进度、收入等

### 7.2 告警机制
- **告警方式**：邮件、短信、企业微信等
- **告警级别**：紧急、重要、普通
- **告警规则**：可自定义告警阈值

### 7.3 日志管理
- **日志分类**：访问日志、错误日志、业务日志
- **日志存储**：集中存储，便于查询和分析
- **日志分析**：支持日志搜索、统计和可视化

## 八、灾难恢复

### 8.1 灾备方案
- **数据灾备**：异地备份，定期恢复测试
- **应用灾备**：多可用区部署，提高系统可用性
- **业务灾备**：制定业务连续性计划，确保业务持续运行

### 8.2 恢复流程
- **故障检测**：自动检测系统故障
- **故障隔离**：隔离故障节点，防止影响其他节点
- **故障恢复**：启动备用节点，恢复系统功能
- **数据恢复**：从备份恢复数据，确保数据一致性
