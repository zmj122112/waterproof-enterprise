# 防水服务平台数据库设计

## 1. 数据库概述

本数据库设计基于防水服务平台的业务需求，支持C端小程序、B端门户、管理系统和师傅端应用的所有功能。数据库采用关系型数据库设计，确保数据的完整性和一致性。

## 2. 核心数据模型

### 2.1 用户表 (users)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| openid | VARCHAR | 100 | UNIQUE | 微信openid |
| unionid | VARCHAR | 100 | UNIQUE | 微信unionid |
| name | VARCHAR | 50 | NOT NULL | 用户姓名 |
| phone | VARCHAR | 20 | UNIQUE, NOT NULL | 手机号码 |
| avatar | VARCHAR | 255 | | 头像URL |
| gender | TINYINT | 1 | | 性别（0:未知, 1:男, 2:女） |
| address | VARCHAR | 255 | | 联系地址 |
| user_type | TINYINT | 1 | NOT NULL DEFAULT 1 | 用户类型（1:C端用户, 2:师傅, 3:B端用户, 4:管理员） |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:正常, 0:禁用） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.2 服务分类表 (service_categories)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 分类ID |
| name | VARCHAR | 50 | NOT NULL | 分类名称 |
| icon | VARCHAR | 50 | | 图标 |
| description | VARCHAR | 255 | | 描述 |
| parent_id | BIGINT | 20 | DEFAULT 0 | 父分类ID |
| sort_order | INT | 11 | DEFAULT 0 | 排序 |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:启用, 0:禁用） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.3 工程案例表 (project_cases)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 案例ID |
| title | VARCHAR | 100 | NOT NULL | 案例标题 |
| description | TEXT | | NOT NULL | 案例描述 |
| images | JSON | | | 案例图片列表（JSON格式） |
| category_id | BIGINT | 20 | NOT NULL | 分类ID |
| category_name | VARCHAR | 50 | | 分类名称（冗余字段） |
| view_count | INT | 11 | DEFAULT 0 | 浏览次数 |
| is_recommend | TINYINT | 1 | DEFAULT 0 | 是否推荐（1:是, 0:否） |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:启用, 0:禁用） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.4 客户评价表 (customer_reviews)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 评价ID |
| user_id | BIGINT | 20 | NOT NULL | 用户ID |
| user_name | VARCHAR | 50 | | 用户姓名（冗余字段） |
| order_id | BIGINT | 20 | | 订单ID |
| master_id | BIGINT | 20 | | 师傅ID |
| master_name | VARCHAR | 50 | | 师傅姓名（冗余字段） |
| content | TEXT | | NOT NULL | 评价内容 |
| rating | TINYINT | 1 | NOT NULL | 评分（1-5） |
| project_type | VARCHAR | 50 | | 项目类型 |
| images | JSON | | | 评价图片列表（JSON格式） |
| likes | INT | 11 | DEFAULT 0 | 点赞数 |
| is_top | TINYINT | 1 | DEFAULT 0 | 是否置顶（1:是, 0:否） |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:已发布, 0:待审核, -1:已拒绝） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.5 师傅表 (masters)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 师傅ID |
| user_id | BIGINT | 20 | UNIQUE, NOT NULL | 用户ID |
| name | VARCHAR | 50 | NOT NULL | 师傅姓名 |
| phone | VARCHAR | 20 | UNIQUE, NOT NULL | 手机号码 |
| avatar | VARCHAR | 255 | | 头像URL |
| job_number | VARCHAR | 20 | UNIQUE, NOT NULL | 工号 |
| title | VARCHAR | 50 | DEFAULT '资深师傅' | 师傅头衔（如金牌工长、高级技师） |
| level | VARCHAR | 20 | DEFAULT '初级师傅' | 师傅等级 |
| rating | DECIMAL | 3,2 | DEFAULT 0.00 | 评分（1-5） |
| experience | VARCHAR | 10 | | 从业年限 |
| service_count | INT | 11 | DEFAULT 0 | 服务次数 |
| region | VARCHAR | 100 | | 所在区域 |
| certifications | JSON | | | 认证信息（JSON格式） |
| score | INT | 11 | DEFAULT 0 | 积分 |
| completed_orders | INT | 11 | DEFAULT 0 | 完成订单数 |
| description | TEXT | | | 师傅介绍 |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:正常, 0:禁用, 2:休息中） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.6 产品表 (products)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 产品ID |
| name | VARCHAR | 100 | NOT NULL | 产品名称 |
| description | TEXT | | NOT NULL | 产品描述 |
| images | JSON | | | 产品图片列表（JSON格式） |
| category_id | BIGINT | 20 | NOT NULL | 分类ID |
| category_name | VARCHAR | 50 | | 分类名称（冗余字段） |
| price | DECIMAL | 10,2 | NOT NULL | 价格 |
| original_price | DECIMAL | 10,2 | | 原价 |
| stock | INT | 11 | DEFAULT 0 | 库存 |
| score | INT | 11 | DEFAULT 0 | 积分 |
| sales | INT | 11 | DEFAULT 0 | 销量 |
| specs | JSON | | | 产品规格（JSON格式） |
| is_recommend | TINYINT | 1 | DEFAULT 0 | 是否推荐（1:是, 0:否） |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:上架, 0:下架） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.7 订单表 (orders)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 订单ID |
| order_no | VARCHAR | 50 | UNIQUE, NOT NULL | 订单号 |
| user_id | BIGINT | 20 | NOT NULL | 用户ID |
| master_id | BIGINT | 20 | | 师傅ID |
| service_id | BIGINT | 20 | | 服务ID |
| product_ids | VARCHAR | 255 | | 产品ID列表（逗号分隔） |
| type | TINYINT | 1 | NOT NULL | 订单类型（1:快速报修, 2:预约上门, 3:产品购买） |
| status | VARCHAR | 20 | NOT NULL | 订单状态（待接单, 已接单, 施工中, 已完成, 已取消, 待支付, 已支付） |
| customer_name | VARCHAR | 50 | NOT NULL | 客户姓名 |
| customer_phone | VARCHAR | 20 | NOT NULL | 客户电话 |
| address | VARCHAR | 255 | NOT NULL | 服务地址 |
| appointment_time | DATETIME | | | 预约时间 |
| problem_description | TEXT | | | 问题描述 |
| project_type | VARCHAR | 50 | | 项目类型 |
| total_amount | DECIMAL | 10,2 | DEFAULT 0 | 总金额 |
| paid_amount | DECIMAL | 10,2 | DEFAULT 0 | 已支付金额 |
| payment_status | TINYINT | 1 | DEFAULT 0 | 支付状态（0:待支付, 1:已支付, 2:已退款） |
| payment_method | TINYINT | 1 | | 支付方式（1:微信支付, 2:支付宝, 3:线下支付） |
| payment_time | DATETIME | | | 支付时间 |
| start_time | DATETIME | | | 开始时间 |
| end_time | DATETIME | | | 结束时间 |
| evaluate_status | TINYINT | 1 | DEFAULT 0 | 评价状态（0:未评价, 1:已评价） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.8 轮播图表 (banners)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 轮播图ID |
| title | VARCHAR | 100 | NOT NULL | 轮播图标题 |
| image | VARCHAR | 255 | NOT NULL | 轮播图图片 |
| link | VARCHAR | 255 | | 跳转链接 |
| sort_order | INT | 11 | DEFAULT 0 | 排序 |
| status | TINYINT | 1 | NOT NULL DEFAULT 1 | 状态（1:启用, 0:禁用） |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2.9 积分表 (scores)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 积分记录ID |
| user_id | BIGINT | 20 | NOT NULL | 用户ID |
| type | VARCHAR | 50 | NOT NULL | 积分类型（接单, 施工, 评价等） |
| action | VARCHAR | 50 | NOT NULL | 积分行为 |
| score | INT | 11 | NOT NULL | 积分变动（正数为增加, 负数为减少） |
| order_id | BIGINT | 20 | | 关联订单ID |
| description | VARCHAR | 255 | | 积分变动描述 |
| created_at | DATETIME | | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |

## 3. 数据库关系图

```
+----------------+     +------------------+     +------------------+
|    users       |     | service_categories|     | project_cases    |
+----------------+     +------------------+     +------------------+
| id             |     | id               |     | id               |
| openid         |     | name             |     | title            |
| unionid        |     | icon             |     | description      |
| name           |     | description      |     | image            |
| phone          |     | parent_id        |     | category_id      |
| avatar         |     | sort_order       |     | view_count       |
| gender         |     | status           |     | status           |
| address        |     | created_at       |     | created_at       |
| user_type      |     | updated_at       |     | updated_at       |
| status         |     +------------------+     +------------------+
| created_at     |
| updated_at     |     +------------------+     +------------------+
+----------------+     | customer_reviews |     |     masters      |
                       +------------------+     +------------------+
                       | id               |     | id               |
                       | user_id          |     | user_id          |
                       | order_id         |     | name             |
                       | master_id        |     | phone            |
                       | content          |     | avatar           |
                       | rating           |     | level            |
                       | project_type     |     | score            |
                       | status           |     | completed_orders |
                       | created_at       |     | description      |
                       | updated_at       |     | status           |
                       +------------------+     | created_at       |
                                               | updated_at       |
+----------------+     +------------------+     +------------------+
|   products     |     |      orders      |
+----------------+     +------------------+
| id             |     | id               |
| name           |     | order_no         |
| description    |     | user_id          |
| image          |     | master_id        |
| category_id    |     | service_id       |
| price          |     | type             |
| original_price |     | status           |
| stock          |     | customer_name    |
| score          |     | customer_phone   |
| status         |     | address          |
| created_at     |     | appointment_time |
| updated_at     |     | description      |
+----------------+     | total_amount     |
                       | paid_amount      |
+----------------+     | payment_status   |
|    banners     |     | created_at       |
+----------------+     | updated_at       |
| id             |     +------------------+
| title          |
| image          |     +------------------+
| link           |     |      scores      |
| sort_order     |     +------------------+
| status         |     | id               |
| created_at     |     | user_id          |
| updated_at     |     | type             |
+----------------+     | action           |
                       | score            |
                       | order_id         |
                       | description      |
                       | created_at       |
                       +------------------+
```

## 4. 数据库索引设计

### 4.1 用户表索引
- PRIMARY KEY: `id`
- UNIQUE: `openid`, `unionid`, `phone`
- INDEX: `user_type`, `status`

### 4.2 订单表索引
- PRIMARY KEY: `id`
- UNIQUE: `order_no`
- INDEX: `user_id`, `master_id`, `status`, `created_at`

### 4.3 师傅表索引
- PRIMARY KEY: `id`
- UNIQUE: `user_id`, `phone`
- INDEX: `status`, `score`

### 4.4 产品表索引
- PRIMARY KEY: `id`
- INDEX: `category_id`, `status`, `created_at`

## 5. 数据库安全设计

1. **密码加密**: 用户密码采用bcrypt算法加密存储
2. **SQL注入防护**: 使用参数化查询，避免直接拼接SQL语句
3. **数据脱敏**: 敏感数据（如手机号码）在查询时进行脱敏处理
4. **访问控制**: 不同角色只能访问其权限范围内的数据
5. **定期备份**: 数据库定期备份，确保数据安全
6. **事务管理**: 关键业务操作使用事务，确保数据一致性
7. **日志记录**: 记录所有数据库操作日志，便于审计和追溯

## 6. 数据库性能优化

1. **合理设计索引**: 为频繁查询的字段创建索引
2. **分表分库**: 对于大数据量的表，考虑分表分库
3. **优化查询语句**: 避免全表扫描，使用合适的查询条件
4. **缓存机制**: 对频繁访问的数据进行缓存
5. **定期清理**: 定期清理无用数据，优化数据库性能
6. **读写分离**: 对于读多写少的场景，考虑读写分离

## 7. 数据库迁移策略

1. **版本控制**: 使用数据库迁移工具（如Flyway、Liquibase）管理数据库版本
2. **自动化迁移**: 实现数据库迁移的自动化，减少人为错误
3. **回滚机制**: 确保每个迁移脚本都有对应的回滚脚本
4. **测试环境验证**: 在测试环境验证迁移脚本，确保无误后再应用到生产环境
5. **生产环境迁移**: 生产环境迁移时，确保业务低峰期进行，减少对业务的影响

## 8. 数据库监控与维护

1. **性能监控**: 监控数据库性能指标，如响应时间、CPU使用率、内存使用率等
2. **慢查询分析**: 定期分析慢查询日志，优化查询语句
3. **数据库健康检查**: 定期进行数据库健康检查，确保数据库正常运行
4. **备份验证**: 定期验证数据库备份，确保备份可用
5. **容量规划**: 定期评估数据库容量，提前进行扩容规划
6. **安全审计**: 定期进行数据库安全审计，发现并修复安全漏洞

## 9. 总结

本数据库设计基于防水服务平台的业务需求，涵盖了C端小程序、B端门户、管理系统和师傅端应用的所有功能。设计中考虑了数据的完整性、一致性、安全性和性能，同时提供了详细的数据库关系图、索引设计、安全设计、性能优化、迁移策略和监控维护方案，为后续的系统开发和运维提供了坚实的基础。